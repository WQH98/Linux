### 一、汇编LED原理分析

#### 1、为什么要学习 Cortex-A 汇编

①、需要用汇编初始化一些 SOC 外设
②、使用汇编初始化 DDR 这一步I.MX6U不需要
③、设置sp指针 一般指向DDR 设置好C语言运行环境

#### 2、ALPHA开发板 LED灯硬件原理分析

![image-20240622001513785](/home/wqh/Project/linux/01_裸机驱动/01_汇编led/笔记/LED硬件.png)

![image-20240622001814524](/home/wqh/Project/linux/01_裸机驱动/01_汇编led/笔记/LEDIO.png)

#### 3、STM32 IO初始化流程

①、使能GPIO时钟
②、设置IO复用 将其设置为GPIO（通用输入输出）
③、配置GPIO的电气属性
④、使用GPIO 输出高/低电平

#### 4、I.MX6U IO初始化

①、使能时钟：CCGR0-CCGR6这7个寄存器控制着I.MX6ULL所有外设时钟的使能 为了简单 设置CCGR0-CCGR6这7个寄存器全部为0xFFFFFFFF 相当于使能了所有外设
②、IO复用：将寄存器 IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03的bit3~0设置为0101=5 这样GPIO1_IO03就复用为GPIO
③、寄存器IOMUXC_SW_PAD_CTL_PAD_GPIO1_IO03是设置GPIO1_IO03的电气属性 包括压摆率、速度、驱动能力、开漏、上下拉等
④、配置GPIO功能 设置输入输出 设置GPIO1_GDIR寄存器bit3为1 设置为输出模式 设置GPIO1_DR寄存器bit3 为1表示输出高电平 为0表示输出低电平这个老师我觉得他还是很有水平的，他之前有一次谈人性争论不休的问题，我受益匪浅。

### 二、汇编简介

汇编由一条条指令构成 指令就设计到汇编指令

```assembly
@ 假设a地址为0x20 b地址为0x30 现在想把b地址存的数据放在a地址上
@ R0拿到b地址的寄存器
LDR R0, =0x30
@ 将b地址存储的数据 放在R1
LDR R1, [R0]
@ R0拿到a地址的数据
LDR R0, =0x20
@ 将R1中保存的b地址的数据 放在a地址
STR R1, [R0]
```

我们在使用汇编编写驱动的时候 最常用的就是LDR和STR这两个指令

#### 1、为什么要学习汇编

对于Cortex-A 芯片来说 大部分芯片在上电后C语言环境还没有准备好 所以第一行程序肯定是汇编的 至于要写多少汇编程序 就看你能在哪一步把C语言环境准备好

#### 2、压栈和出栈

我们通常会在A函数中调用B函数 当B函数执行完以后返回A函数继续执行 要想再跳回A函数以后代码能够接着正常运行 那就必须在调到B函数之前将当前处理器状态保存起来（也就是保存R0~R15这些寄存器值） 当B函数执行完成以后再用前面保存的寄存器值恢复R0~R15即可
保存R0~R15寄存器的操作就叫做现场保护 恢复R0~R15寄存器的操作就叫做恢复现场
在进行现场保护的时候需要进行压栈(入栈)操作 恢复现场就要进行出栈操作
压栈的指令为PUSH 出栈的指令为POP

### 三、编写驱动

#### 1、编译程序

①、使用 arm-linux-gnueabihf-gcc编译工具 将.c和.s文件编译为.o文件
②、将所有的.o文件链接为.elf格式的可执行文件（.elf格式文件中带有调试信息）
③、将.elf文件转为.bin文件
④、将.elf文件转为汇编 反汇编

#### 2、链接

​		链接就是把所有的.o文件链接在一起 并且链接到指定的地方 链接的时候要指定链接起始地址 一般来说 链接起始地址就是代码运行的起始地址
​		对于6ULL来说 链接起始地址应该指向RAM地址 RAM分为内部RAM和外部RAM（也就是DDR ）6ULL内部RAM地址范围0x900000~0x91FFFF 也可以放在外部DDR中 对于ALPHA开发板 512MB字节DDR版本的核心板 DDR范围就是0x80000000~0x9FFFFFFF 对于256MB字节的DDR来说 那就是0x80000000~0x8FFFFFFF
​		裸机代码的链接起始地址是0x87800000 要使用DDR 那么必须要初始化DDR 对于I.MX6ULL来说 bin文件不能直接烧写到SD卡、EMMC、NAND等外置存储中 然后从这些外置存储中启动运行 需要添加一个头部 这个头部信息包含了 DDR 的初始化参数 I.MX系列SOC内部boot rom会从SD卡、EMMC等外设存储中读取头部信息 然后初始化DDR 并且将bin文件拷贝到指定的地方（也就是链接起始地址）
​		bin的运行地址一定要和链接起始地址一致 位置无关代码除外

#### 四、烧写bin文件

​		STM32支持烧写到内部FLASH
​		6ULL支持SD卡、EMMC、NAND FLASH、NOR FLASH、SPI FLASH等等启动
​		对于I.MX而言 不能直接烧写bin文件 必须先在bin文件前面添加头部 完成这个工作 需要使用正点原子提供的imxdownload软件

