##### 一、回顾STM32中断系统

###### 1、STM32中断向量表

​	ARM芯片从0x00000000开始运行，执行指令。从程序开始的地方存放着中断向量表。中断向量表的主要功能是描述了中断对应的中断服务函数。对于STM32来说代码最开始的地方存放堆栈栈顶指针。

###### 2、中断向量偏移

​	一般ARM从0x00000000地址开始运行，对于STM32我们设置链接首地址为0x08000000。如果代码一定要从0x08000000开始运行，那么需要告诉一下SOC内核，也就是设置中断向量偏移。设置SCB的VTOR寄存器为新的中断向量表地址即可。

###### 3、NVIC中断控制器

​	NVIC就是中断管理机构，使能和关闭指定的中断，设置中断优先级。

###### 4、中断服务函数的编写

​	中断服务函数就是中断要做的事。

##### 二、Cortex-A7中断系统

###### 1、Cortex-A7中断向量表

​	Cortex-A中断向量表有8个中断，其中重点关注IRQ。Cortex-A的中断向量表需要用户自己去定义。

###### 2、中断向量偏移

​	我们的裸机例程都是从0x87800000开始的，因此要设置中断向量偏移。

###### 3、GIC中断控制器

​	同NVIC一样，GIC用于管理Cortex-A的中断。GIC提供了开关中断，设置中断优先级。

###### 4、IMX6U中断号

​	为了区分不同的中断，引入了中断号。没一个CPU最多支持1020个中断号。ID0~ID15是给SGI，ID16~ID31是给PPI，剩下的ID32~ID1019给SPI，也就是用于按键中断、串口中断等等。6ULL有128个中断，

###### 5、中断服务函数的编写

​	一个是IRQ中断服务函数的编写，另一个就是在IRQ中断服务函数里面去查找并运行的具体的外设中断服务函数。

##### 三、GIC中断控制器

##### 四、中断实验编写

###### 1、编写按键中断例程

​	KEY0使用UART1_CTS这个IO，编写UART1_CTS的中断代码。

###### 2、修改start.s

​	添加中断向量表，编写复位中断服务函数和IRQ中断服务函数。
​	编写复位中断服务函数，内容如下：
​	①、关闭I Cache、D Cache和MMU。
​	②、设置处理器9种工作模式下对应的SP指针。要使用中断那么必须设置IRQ模式下的SP指针。索性直接设置所有模式下的SP指针。
​	③、清除bss段。
​	④、跳到C函数，也就是main函数。

###### 3、CP15协处理器

​	MCR：将ARM寄存器的数据写入到CP15协处理器中。
​	MRC：将CP15协处理器中的寄存器数据读到ARM寄存器中。
​	MRC：读CP15寄存器，MCR就是写CP15寄存器，MCR指令格式如下，
​	MCR{cond} p15, <opc1> , <RT>, <CRn>, <CRm>, <opc2>
​	cond：指令执行的条件码，如果忽略的话就表示无条件执行。
​	opc1：协处理器要执行的操作码。
​	Rt：ARM源寄存器，要写入到CP15寄存器的数据就保存在此寄存器中。
​	CRn：CP15协处理器的目标寄存器。
​	CRm：协处理器中附加的目标寄存器或者源操作数寄存器，如果不需要附加信	息就将CRm设置为C0，否则不可预测。
​	opc2：可选的协处理器和特定操作码，当不需要的时候要设置为0。
​	现在要关闭I Cache、D Cache和MMU，打开Cortex-A7参考手册到105页，找到SCTLR寄存器，也就是系统控制寄存器，此寄存器bit0用于打开和关闭MMU，bit1用于打开和关闭对齐控制位，bit2用于打开和关闭D cache，bit11用于打开和关闭分支预测，bit12用于控制打开和关闭I Cache。
​	中断向量偏移设置：将新的中断向量表首地址写入到CP15协处理器的VBAR寄存器。
​	IRQ中断服务函数：读取CP15的CBAR寄存器，CBAR寄存器保存了GIC控制器的寄存器组首地址。GIC寄存器组偏移0x1000~0x1FFF为GIC的分发器，0x2000~0x3FFF为CPU接口端。意味着我们可以访问GIC控制器了。代码中，r1寄存器保存着GIC控制器的CPU接口端基地址。读取CPU接口端的GICC_IAR寄存器的值保存到r0寄存器里面，可以从GICC_IAR的bit9~0读取中断ID，我们读取中断ID的目的就是为了得到对应的中断处理函数。system_irqhandler就是具体的中断处理函数，此函数有一个参数，为GICC_IAR寄存器的值。system_irqhandler处理完具体的中断以后，需要将对应的中断ID值写入到GICC_EOIR寄存器里面。

###### 4、6ULL GPIO 中断设置

①、我们首先要设置GPIO的中断触发方式，也就是GPIO_ICR1或ICR2寄存器。触发方式有低电平、高电平、上升沿和下降沿。对于本例程来说，我们设置为KEY0，也就是UART1_CTS这个IO为下降沿触发。
②、使能GPIO对应的中断，设置GPIO_IMR寄存器。
③、处理完中断以后，需要清除中断标志位，也就是清除GPIO_ISR寄存器相应的位。GPIO_ISR寄存器是写1清零。

###### 5、GIC配置

①、使能相应的中断ID。GPIO1_IO18对应的中断ID为67 + 32 = 99。
②、设置相应的中断优先级。
③、注册GPIO1_IO18的中断处理函数。