###### 一、Linux内核定时器原理

1、内核时间管理

①、cortex-m内核使用systick作为系统定时器。
②、硬件定时器、软件定时器，原理是依靠系统定时器来驱动。（系统频率与CPU主频不是一个概念）。
③、Linux内核频率可以配置，图形化界面配置。
④、重点，HZ表示系统节拍率。

2、节拍率高低的缺陷

高节拍率会导致中断的产生更加频繁，频繁的中断会加剧系统的负担。

3、jiffies

Linux内核使用全局变量jiffies来记录从启动以来的系统节拍数。

4、内核定时器

①、软件定时器不像硬件定时器一样，直接给周期值。需要设置期满以后的时间点。
②、定时处理函数。
③、内核定时器不是周期性的，一次定时时间到了以后就会关闭，除非重新打开。

###### 二、驱动编写

1、定义一个定时器，使用结构体timer_list。

2、应用调用ioctl函数，驱动里面会调用unlocked_ioctl和compat_ioctl。ioctl的命令是自己定义的，但还是要符合Linux规范，构建命令使用定义如下。

```c
#define _IO(type, nr);								// 没有参数的命令
#define _IOR(type, nr, size);					// 该命令是从驱动读取数据
#define _IOW(type, nr, size);					// 该命令是从驱动写入数据
#define _IOWR(type, nr, size);				// 双向数据传输
```

